{% extends 'wms/base.html' %}

{% block title %}Skanowanie lokalizacji - RegIn {{ receiving_order.order_number }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-map-marker-alt me-2"></i>Skanowanie lokalizacji
            </h1>
            <a href="{% url 'wms:receiving_order_detail' receiving_order.id %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Powrót
            </a>
        </div>
    </div>
</div>

<!-- Informacje o RegIn -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">RegIn:</dt>
                    <dd class="col-sm-8">{{ receiving_order.order_number }}</dd>
                    
                    <dt class="col-sm-4">ZD:</dt>
                    <dd class="col-sm-8">{{ receiving_order.supplier_order.order_number }}</dd>
                    
                    <dt class="col-sm-4">Dostawca:</dt>
                    <dd class="col-sm-8">{{ receiving_order.supplier_order.supplier_name }}</dd>
                    
                    <dt class="col-sm-4">Pozostało pozycji:</dt>
                    <dd class="col-sm-8">{{ pending_items.count }}</dd>
                </dl>
            </div>
        </div>
    </div>
</div>

<!-- Skanowanie lokalizacji -->
<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-barcode me-2"></i>Skanuj kod lokalizacji
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="receivingScanForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="locationInput" class="form-label">Lokalizacja</label>
                        <div class="autocomplete-container position-relative">
                            <input type="text" 
                                   name="location" 
                                   id="locationInput" 
                                   class="form-control form-control-lg" 
                                   placeholder="Wpisz nazwę lub kod lokalizacji..."
                                   autocomplete="off" 
                                   autofocus
                                   hx-get="{% url 'wms:htmx_locations_autocomplete' %}"
                                   hx-trigger="keyup changed delay:300ms"
                                   hx-target="#location-suggestions"
                                   hx-swap="innerHTML"
                                   hx-include="[name='location']"
                                   hx-vals='{"receiving_id": "{{ receiving_order.id }}"}'>
                            <input type="hidden" id="location-code-hidden" name="location_code" value="">
                            <div id="location-suggestions" 
                                 class="autocomplete-suggestions position-absolute w-100 bg-white border border-top-0 rounded-bottom shadow-sm" 
                                 style="z-index: 1000; display: none;"></div>
                        </div>
                    </div>
                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-arrow-right me-2"></i>Dalej
                        </button>
                    </div>
                </form>
                
                <!-- Dostępne lokalizacje -->
                {% if available_locations %}
                <hr>
                <h6><i class="fas fa-map-marker-alt me-2"></i>Szybki wybór lokalizacji:</h6>
                <p class="text-muted small mb-2">Kliknij lokalizację aby ją wybrać:</p>
                <div class="d-flex flex-wrap gap-2">
                    {% for location in available_locations %}
                    <button type="button" class="btn btn-outline-primary btn-sm" 
                            onclick="selectLocation('{{ location.name }}', '{{ location.barcode }}')">
                        <i class="fas fa-map-marker-alt me-1"></i>{{ location.name }}
                        <small class="text-muted">({{ location.barcode }})</small>
                    </button>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Pozostałe pozycje
                </h5>
            </div>
            <div class="card-body">
                {% if pending_items %}
                    <div class="list-group list-group-flush">
                        {% for item in pending_items %}
                        <div class="list-group-item d-flex justify-content-between align-items-center" 
                             style="cursor: pointer;"
                             hx-get="{% url 'wms:htmx_edit_product_codes' item.product.id %}"
                             hx-swap="none"
                             hx-trigger="click">
                            <div>
                                {{ item.product.name }}
                                <br>
                                {% if item.product.codes.first.code %}
                                    <small class="text-muted">
                                        <i class="fas fa-barcode me-1"></i>{{ item.product.codes.first.code }}
                                    </small>
                                {% else %}
                                    <small class="text-muted">
                                        <i class="fas fa-exclamation-triangle text-warning me-1"></i>Brak kodu kreskowego
                                    </small>
                                {% endif %}
                            </div>
                            <span class="badge bg-primary rounded-pill">{{ item.quantity_ordered }}</span>
                        </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <p class="text-muted mb-0">Wszystkie pozycje zostały przyjęte!</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Przyjęte pozycje -->
{% if received_items %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>Przyjęte pozycje
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Produkt</th>
                                <th>Kod kreskowy</th>
                                <th>Ilość zamówiona</th>
                                <th>Ilość przyjęta</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in received_items %}
                            <tr style="cursor: pointer;"
                                hx-get="{% url 'wms:htmx_edit_product_codes' item.product.id %}"
                                hx-swap="none"
                                hx-trigger="click">
                                <td>
                                    {{ item.product.name }}
                                    {% if item.notes %}
                                        <br><small class="text-muted">{{ item.notes }}</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.product.codes.first.code %}
                                        <i class="fas fa-barcode me-1 text-muted"></i>{{ item.product.codes.first.code }}
                                    {% else %}
                                        <span class="text-muted">
                                            <i class="fas fa-exclamation-triangle text-warning me-1"></i>Brak kodu
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ item.quantity_ordered }}</td>
                                <td>
                                    <span class="text-success">{{ item.quantity_received }}</span>
                                </td>
                                <td>
                                    {% if item.quantity_received == item.quantity_ordered %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Przyjęte
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Częściowo
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Autocomplete functionality for locations
    document.addEventListener('DOMContentLoaded', function() {
        const locationInput = document.getElementById('locationInput');
        const locationCodeInput = document.getElementById('location-code-hidden');
        const suggestionsDiv = document.getElementById('location-suggestions');
        
        if (!locationInput || !locationCodeInput || !suggestionsDiv) return;
        
        // Show suggestions when HTMX response is received
        document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.xhr.responseURL.includes('locations-autocomplete')) {
                const response = event.detail.xhr.responseText;
                if (response.trim()) {
                    suggestionsDiv.innerHTML = response;
                    suggestionsDiv.style.display = 'block';
                    
                    // Add click handlers to suggestions
                    const items = suggestionsDiv.querySelectorAll('.autocomplete-item');
                    items.forEach(item => {
                        item.addEventListener('click', function() {
                            locationInput.value = this.textContent;
                            locationCodeInput.value = this.dataset.locationBarcode;
                            suggestionsDiv.style.display = 'none';
                        });
                    });
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!locationInput.contains(event.target) && !suggestionsDiv.contains(event.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
        
        // Handle direct barcode input (when user types or scans without autocomplete)
        locationInput.addEventListener('input', function(e) {
            const value = e.target.value.trim();
            
            // If input is cleared, clear the hidden field
            if (value === '') {
                locationCodeInput.value = '';
            } 
            // If input looks like a barcode (no spaces, reasonable length), treat it as direct input
            else if (value.length >= 3 && !value.includes(' ')) {
                locationCodeInput.value = value;
            }
            
            // Auto-submit for barcode scanners (when length >= 8 and has code set)
            if (locationCodeInput.value && value.length >= 8) {
                // Small delay to ensure autocomplete doesn't interfere
                setTimeout(function() {
                    if (suggestionsDiv.style.display === 'none') {
                        document.getElementById('receivingScanForm').submit();
                    }
                }, 100);
            }
        });
        
        // Fokus na pole
        locationInput.focus();
    });
    
    // Quick location selection - fills the form and submits
    function selectLocation(name, barcode) {
        const locationInput = document.getElementById('locationInput');
        const locationCodeInput = document.getElementById('location-code-hidden');
        locationInput.value = name + ' (' + barcode + ')';
        locationCodeInput.value = barcode;
        // Auto-submit the form
        document.getElementById('receivingScanForm').submit();
    }
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Autocomplete styles */
    .autocomplete-suggestions {
        max-height: 300px;
        overflow-y: auto;
        border-top: none !important;
    }
    
    .autocomplete-item {
        display: block;
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }
    
    .autocomplete-item:hover {
        background-color: #f8f9fa;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
</style>
{% endblock %} 