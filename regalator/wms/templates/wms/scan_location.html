{% extends 'wms/base.html' %}

{% block title %}Skanowanie lokalizacji - {{ picking_order.order_number }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-barcode me-2"></i>Skanowanie lokalizacji
            </h1>
            <div>
                <a href="{% url 'wms:picking_detail' picking_order.id %}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Powrót
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-map-marker-alt me-2"></i>Zeskanuj lokalizację
                </h5>
            </div>
            <div class="card-body">
                <!-- Informacje o zleceniu -->
                <div class="alert alert-info">
                    <h6 class="alert-heading">
                        <i class="fas fa-clipboard-list me-2"></i>Zlecenie: {{ picking_order.order_number }}
                    </h6>
                    <p class="mb-0">Klient: {{ picking_order.customer_order.customer_name }}</p>
                </div>
                
                <!-- Następna pozycja do kompletacji -->
                {% with next_item=picking_order.next_item %}
                {% if next_item %}
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">
                            <i class="fas fa-arrow-right me-2"></i>Następna pozycja
                        </h6>
                        <p class="mb-1">
                            {{ next_item.product.name }}<br>
                            <small class="text-muted">
                                Kod: {{ next_item.product.code }} | 
                                Ilość: {{ next_item.quantity_to_pick }} {{ next_item.product.unit }} |
                                Lokalizacja: {{ next_item.location.name }}
                            </small>
                        </p>
                    </div>
                {% endif %}
                {% endwith %}
                
                <!-- Formularz skanowania -->
                <form method="post" id="scanForm">
                    {% csrf_token %}
                    <div class="scan-area mb-4">
                        <i class="fas fa-barcode fa-3x text-primary mb-3"></i>
                        <h5>Zeskanuj kod kreskowy lokalizacji</h5>
                        <p class="text-muted">Użyj skanera, wpisz kod ręcznie lub wybierz z listy</p>
                        
                        <div class="row justify-content-center">
                            <div class="col-md-8">
                                <div class="autocomplete-container position-relative">
                                    <div class="input-group">
                                        <span class="input-group-text">
                                            <i class="fas fa-barcode"></i>
                                        </span>
                                        <input type="text" 
                                               name="location" 
                                               id="locationInput" 
                                               class="form-control form-control-lg" 
                                               placeholder="Wpisz nazwę lub kod lokalizacji..."
                                               autocomplete="off" 
                                               autofocus
                                               hx-get="{% url 'wms:htmx_locations_autocomplete' %}"
                                               hx-trigger="keyup changed delay:300ms"
                                               hx-target="#location-suggestions"
                                               hx-swap="innerHTML"
                                               hx-include="[name='location']"
                                               hx-vals='{"picking_id": "{{ picking_order.id }}"}'>
                                        <input type="hidden" id="location-barcode" name="barcode" value="">
                                        <button type="submit" class="btn btn-primary btn-lg">
                                            <i class="fas fa-check"></i>
                                        </button>
                                    </div>
                                    <div id="location-suggestions" 
                                         class="autocomplete-suggestions position-absolute w-100 bg-white border border-top-0 rounded-bottom shadow-sm" 
                                         style="z-index: 1000; display: none;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- Dostępne lokalizacje -->
                {% if available_locations %}
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-map-marker-alt me-2"></i>Szybki wybór lokalizacji
                        </h6>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">
                            Kliknij lokalizację aby ją wybrać:
                        </p>
                        <div class="row">
                            {% for location in available_locations %}
                            <div class="col-md-6 mb-2">
                                <button type="button" class="btn btn-outline-primary btn-sm w-100" 
                                        onclick="selectLocation('{{ location.name }}', '{{ location.barcode }}')">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    {{ location.name }}
                                    <small class="d-block text-muted">{{ location.barcode }}</small>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>Informacje
                </h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-4">Terminacja:</dt>
                    <dd class="col-sm-8">{{ picking_order.order_number }}</dd>
                    
                    <dt class="col-sm-4">Klient:</dt>
                    <dd class="col-sm-8">{{ picking_order.customer_order.customer_name }}</dd>
                    
                    <dt class="col-sm-4">Status:</dt>
                    <dd class="col-sm-8">
                        {% if picking_order.status == 'created' %}
                            <span class="badge bg-secondary">Utworzone</span>
                        {% elif picking_order.status == 'in_progress' %}
                            <span class="badge bg-info">W trakcie</span>
                        {% elif picking_order.status == 'completed' %}
                            <span class="badge bg-success">Zakończone</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-4">Pozycje:</dt>
                    <dd class="col-sm-8">
                        {{ picking_order.completed_items_count }} / {{ picking_order.total_items_count }}
                    </dd>
                </dl>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-list me-2"></i>Pozostałe pozycje
                </h5>
            </div>
            <div class="card-body">
                {% for item in picking_order.pending_items %}
                <div class="d-flex justify-content-between align-items-center mb-2" 
                     style="cursor: pointer;"
                     hx-get="{% url 'wms:htmx_edit_product_codes' item.product.id %}"
                     hx-swap="innerHTML"
                     hx-target="#modalBody"
                     hx-trigger="click">
                    <div>
                        {{ item.product.name }}<br>
                        <small class="text-muted">{{ item.location.name }}</small>
                    </div>
                    <span class="badge bg-secondary">{{ item.quantity_to_pick }} {{ item.product.unit }}</span>
                </div>
                {% empty %}
                <p class="text-muted mb-0">Wszystkie pozycje zostały skompletowane</p>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Skompletowane pozycje -->
{% if picked_items %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>Skompletowane pozycje
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Produkt</th>
                                <th>Lokalizacja</th>
                                <th>Ilość zlecona</th>
                                <th>Ilość pobrana</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in picked_items %}
                            <tr style="cursor: pointer;"
                                hx-get="{% url 'wms:htmx_edit_product_codes' item.product.id %}"
                                hx-swap="innerHTML"
                                hx-target="#modalBody"
                                hx-trigger="click">
                                <td>
                                    {{ item.product.name }}
                                    <br><small class="text-muted">Kod: {{ item.product.code }}</small>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ item.location.name }}</span>
                                </td>
                                <td>{{ item.quantity_to_pick }} {{ item.product.unit }}</td>
                                <td>
                                    <span class="text-success">{{ item.quantity_picked }} {{ item.product.unit }}</span>
                                </td>
                                <td>
                                    {% if item.quantity_picked == item.quantity_to_pick %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check me-1"></i>Skompletowane
                                        </span>
                                    {% else %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Częściowo
                                        </span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
    // Autocomplete functionality for locations
    document.addEventListener('DOMContentLoaded', function() {
        const locationInput = document.getElementById('locationInput');
        const locationBarcodeInput = document.getElementById('location-barcode');
        const suggestionsDiv = document.getElementById('location-suggestions');
        
        if (!locationInput || !locationBarcodeInput || !suggestionsDiv) return;
        
        // Show suggestions when HTMX response is received
        document.body.addEventListener('htmx:afterRequest', function(event) {
            if (event.detail.xhr.responseURL.includes('locations-autocomplete')) {
                const response = event.detail.xhr.responseText;
                if (response.trim()) {
                    suggestionsDiv.innerHTML = response;
                    suggestionsDiv.style.display = 'block';
                    
                    // Add click handlers to suggestions
                    const items = suggestionsDiv.querySelectorAll('.autocomplete-item');
                    items.forEach(item => {
                        item.addEventListener('click', function() {
                            locationInput.value = this.textContent;
                            locationBarcodeInput.value = this.dataset.locationBarcode;
                            suggestionsDiv.style.display = 'none';
                        });
                    });
                } else {
                    suggestionsDiv.style.display = 'none';
                }
            }
        });
        
        // Hide suggestions when clicking outside
        document.addEventListener('click', function(event) {
            if (!locationInput.contains(event.target) && !suggestionsDiv.contains(event.target)) {
                suggestionsDiv.style.display = 'none';
            }
        });
        
        // Handle direct barcode input (when user types or scans without autocomplete)
        locationInput.addEventListener('input', function(e) {
            const value = e.target.value.trim();
            
            // If input is cleared, clear the hidden barcode field
            if (value === '') {
                locationBarcodeInput.value = '';
            } 
            // If input looks like a barcode (no spaces, reasonable length), treat it as direct input
            else if (value.length >= 3 && !value.includes(' ')) {
                locationBarcodeInput.value = value;
            }
            
            // Auto-submit for barcode scanners (when length >= 8 and has barcode set)
            if (locationBarcodeInput.value && value.length >= 8) {
                // Small delay to ensure autocomplete doesn't interfere
                setTimeout(function() {
                    if (suggestionsDiv.style.display === 'none') {
                        document.getElementById('scanForm').submit();
                    }
                }, 100);
            }
        });
        
        // Fokus na pole skanowania
        locationInput.focus();
    });
    
    // Quick location selection - fills the form and submits
    function selectLocation(name, barcode) {
        const locationInput = document.getElementById('locationInput');
        const locationBarcodeInput = document.getElementById('location-barcode');
        locationInput.value = name + ' (' + barcode + ')';
        locationBarcodeInput.value = barcode;
        // Auto-submit the form
        document.getElementById('scanForm').submit();
    }
</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Autocomplete styles */
    .autocomplete-suggestions {
        max-height: 300px;
        overflow-y: auto;
        border-top: none !important;
    }
    
    .autocomplete-item {
        display: block;
        padding: 12px 16px;
        cursor: pointer;
        border-bottom: 1px solid #eee;
        transition: background-color 0.2s;
    }
    
    .autocomplete-item:hover {
        background-color: #f8f9fa;
    }
    
    .autocomplete-item:last-child {
        border-bottom: none;
    }
    
    .scan-area {
        text-align: center;
        padding: 2rem 0;
    }
</style>
{% endblock %} 